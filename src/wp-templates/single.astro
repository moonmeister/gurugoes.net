---
import { client, gql } from "@/lib/client";
import Base from "@/layouts/base.astro";
import CommentSection from "@/components/comments/Section.astro";
import FeaturedImage, {
	FeaturedImageFragment,
} from "@/components/post/FeaturedImage.astro";
import Time from "@/components/Time.astro";
import ReadingTime from "@/components/ReadingTime.astro";
import "@/styles/wpBlocks.css";

const contentResponse = await client.query(
	gql`
		query GetComments($uri: ID!) {
			post(id: $uri, idType: URI) {
				title
				content
				dateGmt
				...FeaturedImage
			}
		}
		${FeaturedImageFragment}
	`,
	{
		uri: Astro.url.pathname,
	},
);

const { content, title, dateGmt, featuredImage } = contentResponse.data.post;

const postId = Astro.locals.nodeSeed.databaseId;
---

<Base>
	<div class="relative overflow-hidden rounded-3xl bg-white">
		{
			contentResponse.error ? (
				<div class="text-red-500">{contentResponse.error}</div>
			) : (
				<>
					<article class="relative">
						<header class="static mx-auto w-full text-lg">
							<div
								class="grid w-full"
								style={{
									gridTemplateColumns: "1fr auto 1fr",
									gridTemplateRows: "1fr auto 1fr",
									gap: "1em",
								}}
							>
								<div class="col-span-full row-span-full">
									<FeaturedImage data={featuredImage} class="max-h-96" />
								</div>
								<h1 class="z-10 col-start-2 col-end-3 row-start-2 row-end-3">
									<span class="mt-2 block rounded-lg bg-green-700/50 p-2 text-center text-3xl leading-8 font-extrabold tracking-tight text-white sm:text-4xl">
										{title}
									</span>
								</h1>
							</div>
							<div class="text-center text-sm leading-8 text-gray-500">
								<Time dateTime={dateGmt} />
								<span aria-hidden="true">&nbsp;&middot;&nbsp;</span>
								<ReadingTime content={content} />
							</div>
						</header>
						<div class="my-16 px-4 sm:px-6 lg:px-8">
							<div
								class="wp-blocks prose-lg prose-green mx-auto mt-6 max-w-prose text-gray-500"
								set:html={content}
							/>
						</div>
					</article>
					<CommentSection {postId} server:defer />
				</>
			)
		}
	</div>
</Base>
